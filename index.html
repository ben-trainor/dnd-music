<!doctype html>
<html lang="en">

    <head>
        <title>Title</title>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS v5.0.2 -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="css/main.css">
        <script src="node_modules/howler/dist/howler.js"></script>
        <script id="music_engine" defer>

            window.onload = function() { // Have to wait for page to load before running anything

                const FADELENGTH = 2000;
                const TIMEOUT = FADELENGTH + 50;


                // Initialize song objects and store them in the parent object
                var howlerObjectsHolder = {
                    pizza: pizza = new Howl({
                            src: ['../audio/music/1 in the end, we all became pizza and ate ourselves.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                pizza.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    paul: paul = new Howl({
                            src: ['../audio/music/2 yeah no paul looks like this.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                paul.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    tasting: tasting = new Howl({
                            src: ['../audio/music/3 tasting flowers.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                tasting.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    hours: hours = new Howl({
                            src: ['../audio/music/4 only mark the bright hours.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                hours.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    igloo: igloo = new Howl({
                            src: ['../audio/music/5 an igloo, perhaps.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                igloo.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    willow: willow = new Howl({
                            src: ['../audio/music/6 wandering willow.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                willow.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    sun: sun = new Howl({
                            src: ['../audio/music/7 we haven\'t seen the sun for three days.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                sun.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    happenings: happenings = new Howl({
                            src: ['../audio/music/8 places, things, and happenings.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                happenings.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        }),
                    noise: noise = new Howl({
                            src: ['../audio/sfx/noise.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                noise.fade(0, 1, FADELENGTH);
                            },
                            loop: true
                        })
                }

                
                // Make a collection of all the buttons with the "music-button" class
                var musicButtons =  document.getElementsByClassName("music-button");
                var songIDs = Array; // Note: JavaScript Arrays are mutable
                var defaultSong;
                var currentSong = {
                    obj_play: "",
                    obj_fade: "",
                    id_play: "",
                    id_fade: ""
                };
                var loading = false;
                var songIsPlaying = false;
                var songIsCrossfading = false;
                var noSongYet = true;

                var alert = document.createElement('div');
                alert.className = "alert alert-warning alert-dismissible fade show position-absolute shadow text-center top-0 left-50 mt-3 p-3";

                storeButtonSongs();
                setButtonSongs();

                // Store button IDs in array for later use
                function storeButtonSongs() {
                    // Loop through both array and collection to read and store
                    for (let i = 0; i < musicButtons.length; i++) {
                        songIDs[i] = musicButtons.item(i).id.toString();
                        // console.log("Storing " + songIDs[i]);
                    }
                }

                // Generate onclick events for each button with class "music-button"
                function setButtonSongs() {
                    for (let i = 0; i < musicButtons.length; i++) {
                        musicButtons.item(i).addEventListener("click", function() {
                            musicLogic(this.id); // e.g., onclick="musicLogic(pizza)"
                        });
                    }
                }

                
                /*** BEGIN PROPER MUSIC ENGINE ***/
                
                // Primary logic for playback
                function musicLogic(id) {

                    // console.log("ID found: " + id);

                    // Catching exception if no song is actually playing
                    if (id == "killAll") {
                        console.log("Killing everything.");
                        Howler.stop();
                    }

                    else if (id == "stop" && noSongYet == true) {
                        alert.innerHTML = "No songs are playing!";
                        document.getElementById("full_page").append(alert);
                        console.log("No songs are playing!");
                        setTimeout(() => {
                            alert.remove();
                        }, TIMEOUT);
                    }
                    
                    else if (loading == true && id != "stop") {
                        alert.innerHTML = "Have patience, young padawan.";
                        document.getElementById("full_page").append(alert);
                        console.log("Please wait for song to finish loading.");
                    }

                    else if (loading == true && id == "stop") {
                        alert.innerHTML = "Hold your horses there, bucko. We're working on it.";
                        document.getElementById("full_page").append(alert);
                        console.log("Please wait for song to finish loading.");
                    }

                    else if (id == "stop" && loading == false && noSongYet == false) {

                        loading = true;
                        console.log("Stopping music...");

                        // Add spinner to clicked button
                        var spinner = document.createElement('div');
                        spinner.className = "spinner-border float-end";
                        var currentButton = document.getElementById(id);
                        currentButton.append(spinner);

                        // Fade out audio
                        currentSong.obj_play.fade(1, 0, FADELENGTH);

                        setTimeout(() => {
                            console.log("Done stopping.");
                            currentSong.obj_play.stop(currentSong.id_play);
                            spinner.remove();
                            alert.remove();
                            loading = false;
                            noSongYet = true;
                        }, TIMEOUT);

                    }

                    else if (id != "stop" && loading == false) {
                        tryToPlay(howlerObjectsHolder[id], id);
                        noSongYet = false;
                    }


                }

                // Attempt to start playing song when triggered
                function tryToPlay(howlerObj, id) {

                    loading = true;

                    // Add spinner to clicked button
                    var spinner = document.createElement('div');
                    spinner.className = "spinner-border float-end";
                    var currentButton = document.getElementById(id);
                    currentButton.append(spinner);

                    // Start song and music mode if page is silent
                    if (songIsPlaying == false) {
                        console.log("Starting music...");

                        // Store song instance ID and object to be passed
                        currentSong.id_play = howlerObj.play();
                        currentSong.obj_play = howlerObj;

                        songIsPlaying = true;
                    }

                    // Crossfade between tracks if a song is playing already
                    else {
                        songIsCrossfading = true;
                        crossFade(howlerObj);
                        songIsCrossfading = false;
                    }

                    // Artificially wait to hide the loading spinner
                    setTimeout(() => {
                        console.log("Done loading.");
                        spinner.remove();
                        alert.remove();
                        loading = false;
                    }, TIMEOUT);

                }
                
                // Fade out currently playing song
                function crossFade(howlerObj) {

                    console.log("Crossfading...");

                    currentSong.obj_fade = currentSong.obj_play;
                    currentSong.id_fade = currentSong.id_play;
                    currentSong.obj_play = howlerObj;
                    currentSong.id_play = howlerObj.play();

                    currentSong.obj_fade.fade(1, 0, FADELENGTH);
                    
                    // Wait until after fade to stop previous song
                    setTimeout(() => {
                        console.log("Done fading. Stopping previous song...");
                        currentSong.obj_fade.stop(currentSong.id_fade);
                    }, TIMEOUT);

                    if (songIsCrossfading == true) {
                        songIsPlaying = true;
                    }
                    else {
                        songIsPlaying = false;
                    }

                }

            }

        </script>
        <script id="ambience_engine" defer>

            window.onload = function() {

                const FADELENGTH = 2000;
                const TIMEOUT = FADELENGTH + 50;

                var ambiencesHolder = {
                    fire_crackling1: fire_crackling1 = new Howl({
                            src: ['../audio/music/1 in the end, we all became pizza and ate ourselves.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                fire_crackling1.fade(0, 1, FADELENGTH);
                            },
                            loop: true,
                            volume: .7
                        }),
                    fire_crackling2: fire_crackling2 = new Howl({
                            src: ['../audio/music/2 yeah no paul looks like this.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                fire_crackling2.fade(0, 1, FADELENGTH);
                            },
                            loop: true,
                            volume: .7
                        }),
                    fire_crackling3: fire_crackling3 = new Howl({
                            src: ['../audio/music/3 tasting flowers.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                fire_crackling3.fade(0, 1, FADELENGTH);
                            },
                            loop: true,
                            volume: .7
                        }),
                    fire_crackling4: fire_crackling4 = new Howl({
                            src: ['../audio/music/4 only mark the bright hours.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                fire_crackling4.fade(0, 1, FADELENGTH);
                            },
                            loop: true,
                            volume: .7
                        }),
                    fire_crackling5: fire_crackling5 = new Howl({
                            src: ['../audio/sfx/noise.mp3'],
                            onplay: function() {
                                console.log("Fading in...");
                                fire_crackling5.fade(0, 1, FADELENGTH);
                            },
                            loop: true,
                            volume: .7
                        })         
                }


                var ambienceButtons = document.getElementsByClassName("ambience-button");
                var ambienceButtonIDs = Array;

                var playingAmbiencesIndex = 0;
                var stopIndex = "";
                var playingAmbiencesButtonIDs = [""];
                var playingAmbiencesPlayIDs = [""];

                var clickedAmbienceIsPlaying = false;

                storeAmbiences();
                setAmbiences();


                function storeAmbiences() {
                    for (let i = 0; i < ambienceButtons.length; i++) {
                        ambienceButtonIDs[i] = ambienceButtons.item(i);
                    }
                }

                function setAmbiences() {
                    for (let i = 0; i < ambienceButtons.length; i++) {
                        ambienceButtons.item(i).addEventListener("click", function() {
                            ambienceLogic(this.id);
                        });
                    }
                }


                function ambienceLogic(ambienceID) {

                    console.log("ID found: " + ambienceID);

                    // Look through playingAmbiencesButtonIDs array to see if ID is listed
                    for (let i = 0; i < playingAmbiencesButtonIDs.length; i++) {
                        console.log("Checking index " + i + " against " + playingAmbiencesButtonIDs[i]);
                        if (ambienceID == playingAmbiencesButtonIDs[i]) {
                            console.log(ambienceID + " is playing!");
                            clickedAmbienceIsPlaying = true;
                            stopIndex = i;
                            break;
                        }
                    }
                    
                    if (clickedAmbienceIsPlaying == false) {
                        // play clicked ambience
                        // store button ID and play() ID in arrays
                        console.log("Playing " + ambienceID);

                        playingAmbiencesButtonIDs[playingAmbiencesIndex] = ambienceID;
                        console.log("playingAmbiencesButtonIDs [" + playingAmbiencesIndex + ", " + ambienceID + " ]");

                        playingAmbiencesPlayIDs[playingAmbiencesIndex] = ambiencesHolder[ambienceID].play();
                        
                        playingAmbiencesIndex++;
                        console.log("Increasing index...");
                    }

                    else if (clickedAmbienceIsPlaying == true) {
                        // fade clicked ambience
                        // remove from array of playing ambiences array
                        console.log("Searching for " + ambienceID);
                        ambiencesHolder[ambienceID].stop(playingAmbiencesPlayIDs[stopIndex]);
                        playingAmbiencesPlayIDs.splice(stopIndex, 1);
                        playingAmbiencesButtonIDs.splice(stopIndex, 1);
                        clickedAmbienceIsPlaying = false;
                        playingAmbiencesIndex--;
                    }
                    
                }

            }
            
        </script>
        
    </head>


    <body class="row p-0 m-0" id="full_page">

        <!-- Offcanvas menu -->
        <header>

            <nav class="navbar navbar-dark position-absolute top-0 start-0 m-0 p-2">
                <button class="navbar-toggler bg-second" type="button" data-bs-toggle="offcanvas" data-bs-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </nav>

              
            <div class="offcanvas offcanvas-start rounded-end" tabindex="-1" id="navbarToggleExternalContent" aria-labelledby="offcanvasExampleLabel">
                
                <!-- Menu title -->
                <div class="offcanvas-header m-0 p-3 px-4">
                    <h4 class="offcanvas-title" id="offcanvasExampleLabel">DND-MUSIC</h4>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>

                <!-- Menu stuff -->
                <div class="row offcanvas-body m-0 p-0 fs-5" id="menu">

                    <div class="list-group list-group-flush rounded m-0 p-2">
                        <a class="list-group-item list-group-item-action p-3" href="#">soundboard</a>
                        <a class="list-group-item list-group-item-action p-3" href="#">dice rolling</a>
                        <a class="list-group-item list-group-item-action p-3" href="#">music database</a>
                        <a class="list-group-item list-group-item-action p-3" href="#">about this project</a>
                        <a class="list-group-item list-group-item-action p-3" href="#">support/contribute</a>
                    </div>

                </div>
                    
                <div class="" id="mixer">
                </div>

                <div class="bottom-0 px-4" id="copyright">
                    <p>&copy;2021 ben trainor</p>
                </div>

            </div>

        </header>


            
        <div class="row text-center m-0 p-0">

            <!-- Ambience -->
            <div class="col-md-5 bg-dark text-dark p-md-0 p-2 m-0 gap-0 audio-container">

                <div class="row m-0 p-0 py-4" id="ambience">
                    
                    <h1 class="text-sh text-light text-sh-main-dark mb-3">AMBIENCE</h1>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                        <div class="row form-check form-switch m-0 px-lg-5 p-0 py-3 bg-white rounded">
                            <label class="col-xl-8 form-check-label float-start p-0 pt-1 m-0 text-xl-start fs-5" for="fire_crackling1">Fire crackling 1</label>
                            <label class="switch mt-xl-1 mb-xl-0 mt-3 mb-1 float-xl-end">
                                <input type="checkbox" class="ambience-button" id="fire_crackling1">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                        <div class="row form-check form-switch m-0 px-lg-5 p-0 py-3 bg-white rounded">
                            <label class="col-xl-8 form-check-label float-start p-0 pt-1 m-0 text-xl-start fs-5" for="fire_crackling2">Fire crackling 2</label>
                            <label class="switch mt-xl-1 mb-xl-0 mt-3 mb-1 float-xl-end">
                                <input type="checkbox" class="ambience-button" id="fire_crackling2">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                        <div class="row form-check form-switch m-0 px-lg-5 p-0 py-3 bg-white rounded">
                            <label class="col-xl-8 form-check-label float-start p-0 pt-1 m-0 text-xl-start fs-5" for="fire_crackling3">Fire crackling 3</label>
                            <label class="switch mt-xl-1 mb-xl-0 mt-3 mb-1 float-xl-end">
                                <input type="checkbox" class="ambience-button" id="fire_crackling3">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                        <div class="row form-check form-switch m-0 px-lg-5 p-0 py-3 bg-white rounded">
                            <label class="col-xl-8 form-check-label float-start p-0 pt-1 m-0 text-xl-start fs-5" for="fire_crackling4">Fire crackling 4</label>
                            <label class="switch mt-xl-1 mb-xl-0 mt-3 mb-1 float-xl-end">
                                <input type="checkbox" class="ambience-button" id="fire_crackling4">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                        <div class="row form-check form-switch m-0 px-lg-5 p-0 py-3 bg-white rounded">
                            <label class="col-xl-8 form-check-label float-start p-0 pt-1 m-0 text-xl-start fs-5" for="fire_crackling5">Fire crackling 5</label>
                            <label class="switch mt-xl-1 mb-xl-0 mt-3 mb-1 float-xl-end">
                                <input type="checkbox" class="ambience-button" id="fire_crackling5">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="row col-md-12 col-6 m-0 my-lg-0 px-xl-4 px-md-3 p-2">
                    </div>

                </div>

                
            </div>
    
            <!-- Music -->
            <div class="row col-md-7 text-dark bg-main-dark pt-4 p-0 m-0 audio-container" id="music">
                
                <h1 class="text-sh-dark text-light mb-xl-4 mb-4">MUSIC</h1>

                <ul class="row list-group-flush text-start bg-white m-0 px-xl-4 pb-xl-4 pb-2 p-0 gap-xl-4 gap-3">

                    <li class="list-group-item pt-4">
                        <h4 class="ms-1 mb-2 m-0">Chill</h4>
                    </li>
                    <li class="d-xl-flex flex-xl-row d-md-grid d-flex flex-row m-0 px-3 gap-xl-4 gap-3">
                        <button id="pizza" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">Chill 1</button>
                        <button id="paul" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">Guitar</button>
                        <button id="tasting" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">Piano</button>
                    </li>

                    <li class="list-group-item pt-4">
                        <h4 class="ms-1 mb-2 m-0">Upbeat</h4>
                    </li>
                    <li class="d-xl-flex flex-xl-row d-md-grid d-flex flex-row m-0 px-3 gap-xl-4 gap-3">
                        <button id="hours" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">only mark the bright hours</button>
                        <button id="igloo" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">an igloo, perhaps</button>
                        <button id="willow" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">wandering willow</button>
                    </li>
                    <li class="d-xl-flex flex-xl-row d-md-grid d-flex flex-row m-0 px-3 gap-xl-4 gap-3 pt-0 mt-0">
                        <button id="sun" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">we haven't seen the sun for three days</button>
                    </li>

                    
                    <li class="list-group-item pt-4">
                        <h4 class="ms-1 mb-2 m-0">Battle</h4>
                    </li>
                    <li class="d-xl-flex flex-xl-row d-md-grid d-flex flex-row m-0 p-0 px-3 gap-xl-4 gap-3">
                        <button id="happenings" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">places, things, and happenings</button>
                        <button id="noise" class="list-group-item list-group-item-action music-button p-3 border-1 rounded">Noise</button>
                    </li>
                    
                </ul>

                <div class="row p-5 m-0 bottom-0 bg-light">
                    <div class="col-6"><a id="stop" class="btn btn-lg btn-success text-light music-button">STOP</a></div>
                    <div class="col-6"><a id="killAll" class="btn btn-lg btn-danger music-button">KILL</a></div>
                </div>

            </div>

        </div>

        
        
        
        
        
        
        
        
        
        
        
        
        <!-- Bootstrap JavaScript Libraries -->
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    </body>
</html>